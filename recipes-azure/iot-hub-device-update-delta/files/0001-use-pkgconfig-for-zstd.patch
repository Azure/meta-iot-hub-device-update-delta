From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Yocto Build <build@yoctoproject.org>
Date: Thu, 12 Dec 2024 00:00:00 +0000
Subject: [PATCH] Use PkgConfig to find zstd for Yocto builds

Yocto's zstd package doesn't provide CMake config files, so use
pkg-config instead to locate the library.

Upstream-Status: Inappropriate [Yocto-specific]
Signed-off-by: Yocto Build <build@yoctoproject.org>
---
 src/native/diffs/core/gtest/CMakeLists.txt              | 5 ++++-
 src/native/diffs/recipes/basic/gtest/CMakeLists.txt     | 5 ++++-
 src/native/diffs/recipes/compressed/gtest/CMakeLists.txt | 5 ++++-
 src/native/io/compressed/CMakeLists.txt                 | 9 +++++++--
 4 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/src/native/diffs/core/gtest/CMakeLists.txt b/src/native/diffs/core/gtest/CMakeLists.txt
index 1111111..2222222 100644
--- a/src/native/diffs/core/gtest/CMakeLists.txt
+++ b/src/native/diffs/core/gtest/CMakeLists.txt
@@ -9,7 +9,10 @@ add_library(diffs_core_gtest
         )
 
 find_package(ZLIB REQUIRED)
-find_package(zstd CONFIG REQUIRED)
+
+# Use PkgConfig to find zstd since it doesn't provide CMake config in Yocto
+find_package(PkgConfig REQUIRED)
+pkg_check_modules(ZSTD REQUIRED libzstd)
 
 target_link_libraries(diffs_core_gtest PUBLIC 
         diffs_core
diff --git a/src/native/diffs/recipes/basic/gtest/CMakeLists.txt b/src/native/diffs/recipes/basic/gtest/CMakeLists.txt
index 1111111..2222222 100644
--- a/src/native/diffs/recipes/basic/gtest/CMakeLists.txt
+++ b/src/native/diffs/recipes/basic/gtest/CMakeLists.txt
@@ -8,7 +8,10 @@ add_library(diffs_recipes_basic_gtest
         )
 
 find_package(ZLIB REQUIRED)
-find_package(zstd CONFIG REQUIRED)
+
+# Use PkgConfig to find zstd since it doesn't provide CMake config in Yocto
+find_package(PkgConfig REQUIRED)
+pkg_check_modules(ZSTD REQUIRED libzstd)
 
 target_link_libraries(diffs_recipes_basic_gtest PUBLIC 
         diffs_recipes_basic
diff --git a/src/native/diffs/recipes/compressed/gtest/CMakeLists.txt b/src/native/diffs/recipes/compressed/gtest/CMakeLists.txt
index 1111111..2222222 100644
--- a/src/native/diffs/recipes/compressed/gtest/CMakeLists.txt
+++ b/src/native/diffs/recipes/compressed/gtest/CMakeLists.txt
@@ -7,7 +7,10 @@ add_library(diffs_recipes_compressed_gtest
         )
 
 find_package(ZLIB REQUIRED)
-find_package(zstd CONFIG REQUIRED)
+
+# Use PkgConfig to find zstd since it doesn't provide CMake config in Yocto
+find_package(PkgConfig REQUIRED)
+pkg_check_modules(ZSTD REQUIRED libzstd)
 
 target_link_libraries(diffs_recipes_compressed_gtest PUBLIC 
         diffs_recipes_compressed
diff --git a/src/native/io/compressed/CMakeLists.txt b/src/native/io/compressed/CMakeLists.txt
index 1111111..2222222 100644
--- a/src/native/io/compressed/CMakeLists.txt
+++ b/src/native/io/compressed/CMakeLists.txt
@@ -19,12 +19,17 @@ if(UNIX)
 endif()
 
 find_package(ZLIB REQUIRED)
-find_package(zstd CONFIG REQUIRED)
+
+# Use PkgConfig to find zstd since it doesn't provide CMake config in Yocto
+find_package(PkgConfig REQUIRED)
+pkg_check_modules(ZSTD REQUIRED libzstd)
 
 target_link_libraries(io_compressed PUBLIC errors io io_sequential)
 
 if(UNIX)
-target_link_libraries(io_compressed PUBLIC zstd::libzstd_static)
+target_link_libraries(io_compressed PUBLIC ${ZSTD_LIBRARIES})
+target_include_directories(io_compressed PRIVATE ${ZSTD_INCLUDE_DIRS})
+target_compile_options(io_compressed PRIVATE ${ZSTD_CFLAGS_OTHER})
 target_link_libraries(io_compressed PRIVATE ZLIB::ZLIB)
 target_link_libraries(io_compressed PUBLIC ${ZLIB_LIBRARIES})
 elseif(WIN32)
-- 
2.39.0
