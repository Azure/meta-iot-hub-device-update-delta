SUMMARY = "Azure IoT Hub Device Update Delta Processor with Tests"
DESCRIPTION = "C++ library for applying deltas and low-level delta creation, including comprehensive test suite"
HOMEPAGE = "https://github.com/Azure/iot-hub-device-update-delta"
LICENSE = "MIT"
LIC_FILES_CHKSUM = "file://LICENSE;md5=d4a904ca135bb7bc912156fee12726f0"

SRC_URI = "git://github.com/Azure/iot-hub-device-update-delta.git;protocol=https;branch=main"
SRCREV = "${AUTOREV}"

S = "${WORKDIR}/git"

DEPENDS = "cmake-native ninja-native zlib zstd bzip2 libgcrypt fmt jsoncpp googletest"

# Runtime dependencies
RDEPENDS:${PN} = "zlib zstd bzip2 libgcrypt fmt jsoncpp"

inherit cmake pkgconfig ptest

# Set C++ standard
CXXFLAGS:append = " -std=c++20"

# CMake configuration with testing enabled
EXTRA_OECMAKE = " \
    -DCMAKE_BUILD_TYPE=Release \
    -DBUILD_TESTING=ON \
    -DENABLE_TESTING=ON \
    -DGTEST_ROOT=${STAGING_LIBDIR} \
    -DGTEST_LIBRARY=${STAGING_LIBDIR}/libgtest.so \
    -DGTEST_MAIN_LIBRARY=${STAGING_LIBDIR}/libgtest_main.so \
    -DGTEST_INCLUDE_DIR=${STAGING_INCDIR} \
"

# Override source directory for CMake
OECMAKE_SOURCEPATH = "${S}/src/native"

# Test configuration
PTEST_ENABLED = "1"

do_compile_ptest() {
    # Tests are built as part of the main build when BUILD_TESTING=ON
    bbdebug 1 "Tests compiled as part of main build"
}

do_install_ptest() {
    # Install test binaries
    install -d ${D}${PTEST_PATH}/bin
    
    # Find and install all test executables
    find ${B} -name "*test*" -type f -executable | while read test_binary; do
        if [ -f "$test_binary" ]; then
            bbdebug 1 "Installing test binary: $test_binary"
            install -m 0755 "$test_binary" ${D}${PTEST_PATH}/bin/$(basename $test_binary)
        fi
    done
    
    # Install test data
    if [ -d "${S}/data" ]; then
        cp -r ${S}/data ${D}${PTEST_PATH}/
    fi
    
    # Create test runner script
    cat > ${D}${PTEST_PATH}/run-ptest << 'SCRIPT_EOF'
#!/bin/bash

# Azure IoT Hub Device Update Delta Test Runner
TEST_DIR="$(dirname "$0")"
TEST_DATA_ROOT="$TEST_DIR/data"
PASS=0
FAIL=0

echo "=== Azure IoT Hub Device Update Delta Test Suite ==="
echo "Test directory: $TEST_DIR"
echo "Test data root: $TEST_DATA_ROOT"
echo

# Function to run a test
run_test() {
    local test_name="$1"
    local test_binary="$2"
    local test_args="$3"
    
    echo "Running: $test_name"
    if [ -x "$test_binary" ]; then
        if $test_binary $test_args; then
            echo "PASS: $test_name"
            PASS=$((PASS + 1))
        else
            echo "FAIL: $test_name"
            FAIL=$((FAIL + 1))
        fi
    else
        echo "SKIP: $test_name (binary not found or not executable)"
    fi
    echo
}

# Run all available tests
find "$TEST_DIR/bin" -name "*test*" -type f -executable | while read test_binary; do
    test_name=$(basename "$test_binary")
    
    case "$test_name" in
        *gtest*)
            # For gtest binaries, pass test data root if available
            if [ -d "$TEST_DATA_ROOT" ]; then
                run_test "$test_name" "$test_binary" "--test_data_root=$TEST_DATA_ROOT"
            else
                run_test "$test_name" "$test_binary" ""
            fi
            ;;
        *)
            run_test "$test_name" "$test_binary" ""
            ;;
    esac
done

# Summary
echo "=== Test Summary ==="
echo "PASSED: $PASS"
echo "FAILED: $FAIL"
echo "TOTAL:  $((PASS + FAIL))"

if [ $FAIL -eq 0 ]; then
    echo "All tests passed!"
    exit 0
else
    echo "Some tests failed!"
    exit 1
fi
SCRIPT_EOF

    chmod +x ${D}${PTEST_PATH}/run-ptest
}

# Standard installation with libraries and tools
do_install:append() {
    # Install libraries
    install -d ${D}${libdir}
    
    # Find and install shared libraries
    find ${B} -name "*.so" -type f | while read lib; do
        if [ -f "$lib" ]; then
            bbdebug 1 "Installing library: $lib"
            install -m 0755 "$lib" ${D}${libdir}/$(basename $lib)
        fi
    done
    
    # Install headers
    install -d ${D}${includedir}/azure-delta
    if [ -d "${S}/src/diffs/api" ]; then
        find ${S}/src/diffs/api -name "*.h" -exec cp {} ${D}${includedir}/azure-delta/ \;
    fi
    
    # Install tools
    install -d ${D}${bindir}
    find ${B} -name "applydiff" -type f -executable | while read tool; do
        if [ -f "$tool" ]; then
            bbdebug 1 "Installing tool: $tool"
            install -m 0755 "$tool" ${D}${bindir}/$(basename $tool)
        fi
    done
    
    # Install additional tools if they exist
    for tool_name in "dumpextfs" "zstd_compress_file"; do
        find ${B} -name "$tool_name" -type f -executable | while read tool; do
            if [ -f "$tool" ]; then
                bbdebug 1 "Installing tool: $tool"
                install -m 0755 "$tool" ${D}${bindir}/$(basename $tool)
            fi
        done
    done
}

# Enhanced file packaging
FILES:${PN} = "${libdir}/*.so ${bindir}/*"
FILES:${PN}-dev = "${includedir}/*"
FILES:${PN}-ptest = "${PTEST_PATH}/*"

PACKAGES = "${PN} ${PN}-dev ${PN}-ptest"

# Enhanced package descriptions
DESCRIPTION:${PN}-ptest = "Test suite for Azure IoT Hub Device Update Delta Processor"
SUMMARY:${PN}-ptest = "Azure IoT Hub Device Update Delta Processor tests"

# Skip QA checks that might fail during development
INSANE_SKIP:${PN} = "dev-so"
INSANE_SKIP:${PN}-ptest = "debug-files"

# Ensure tests run during build validation
do_check() {
    if ${@bb.utils.contains('DISTRO_FEATURES', 'ptest', 'true', 'false', d)}; then
        bbplain "Running build-time tests..."
        
        # Run a quick smoke test to ensure basic functionality
        if [ -x "${B}/tools/applydiff/applydiff" ]; then
            bbplain "applydiff tool built successfully"
        else
            bbwarn "applydiff tool not found"
        fi
        
        # Check if libraries were built
        lib_count=$(find ${B} -name "*.so" -type f | wc -l)
        bbplain "Built $lib_count shared libraries"
        
        if [ $lib_count -eq 0 ]; then
            bbfatal "No shared libraries were built"
        fi
    fi
}

addtask check after do_compile before do_install